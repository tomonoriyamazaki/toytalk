# toytalk
SS Bootcamp 3rd #2025

## プロジェクト
- 声をかけると返答してくれるAIおもちゃの作成
- 目的は親の時間確保
- 子供がおもちゃに夢中になると同時に、言葉のキャッチボール力の向上もできたらうれしい
- OpenAIのAPIを利用するため、会話のたびに料金が発生する
- APIキーを発行してセットすれば、課金分のみの利用が可能
- APIキーの設定が面倒であれば、月額課金でも利用できる
- 無料で使用することも可能。会話はできないが、ただおうむ返しをしたり、事前にセットした昔話を話してくれる、という機能もあると親としては助かる（実際はサーバー維持費用かかるので検討中）
- おもちゃイメージ　「まねっこぴょこぴょこアンパンマン」
  - https://www.amazon.co.jp/gp/product/B0B4RQ85ZQ/ref=sw_img_1?smid=AN1VRQENFRJN5&th=1


## 音声会話のしくみ
  1. STT（音声→テキスト）
  2. LLM
  3. TTS（テキスト→音声）

前提として
  - OpenAIのAPIキーが必要。API利用のたびに課金が発生する
  - 音声処理はスマホ側で行うため、スマホアプリが必要。課金状況の確認などもアプリで行う


## PJの流れ
- デモサイト構築：マイク→音声→テキスト→LLM→音声返答してくれるサイトを作る　→6月完了
- ラズパイに落とし込む　→7月完了
- スマホアプリを作って、スマホと連動させる
- おもちゃとしてデザインを決めて形にする
- →一旦ここまで出来たらうれしい

サービス化するなら
- 何よりも応答速度が課題：デモサイト上では1往復で5秒前後かかる。すべての処理が直列なのと、サーバーレス構成のためと思われる
  - STT：ここが足を引っ張っているように感じる。websocket通信で高速化できないか検討中　※ここをブラウザのテキスト化機能にしたら（つまりSSTをなくしたら）、往復で1-4秒と速度アップした
  - LLM：4.1-miniを利用。かなり早いはず
  - TTS：回答内容をまとめてmp3にしている？ためか長文だと時間かかるように感じる。子供向けということで、LLMの回答内容をシンプルにすることで短縮できないか
  - ※最悪難しかったら、待ってる間に「相槌を打つ」機能の追加を検討。「そうだね～」、「なるほどね」、「ふむふむ」とかいろいろなパターンを使って時間を稼げないか検討
  - →OpenAIのRealTime APIを使えば、SST→LLM→TTSをリアルタイム&並列化できるため爆速になる。ただ、これには2つのデメリットがある
    - 利用料が高い
    - ボイスをカスタマイズ（キャラクター化）できない
  - この対策として、以下が考えられる
    - STT、LLM、TTSそれぞれ、Stream対応のAPIを利用して、自前でWebRTC環境を整備する
    - TTS（ボイス化）についてはさらにカスタマイズできるものを選ぶ　※Microsoft EdgeTTSが有力
    - 一方で開発が長引く可能性が高いので、どこまで対応するか線引きが必要になりそう
    - 一旦、動作が安定してる現状のサーバーレス構成で進めて、RealTime API利用など検証しつつ落としどころを探る
  - 20250901：速度問題は一旦解決。サーバーレス構成（Lambda）でも、LLM/TTSをストリーム処理することで、話初めの速度を改善できた。STTは現在スマホ側で処理しているので、スマホによって性能の差がある可能性あり。もしSTTをサーバー側で処理する場合、少し工夫が必要。現在構想しているのは、APIGW WebSoeckt + Lambdaの二重化
- 音声の精度を高める（くしゃみとか物音も拾ってしまう）
- アプリ上で課金管理をできるようにする
- 過去の会話を踏まえて会話する機能。3-5つくらいまで保持しして、あとは要約するとか工夫できないか（会話積み重ねると重くなる）　→　実装済み
- APIキー管理の仕組みを設計・実装
- 会話保持、振り返り機能の実装
- 無料で利用する場合のおうむ返し機能、昔話をしてくれる機能の設計・実装
- ボイスとテンションを子供向けにする

## デモサイト　※対応済み
- https://toytalk.zakicorp.com/demo/index.html

### レビューいただいてからの修正点まとめ
- 音声を検知するまで何もしない処理にする
- キャラクター入れる
- アニメーション入れる
- キャラクター選択できる
  - 画像をそれぞれ用意する
- 処理時間を表示させる
- 会話ボタンを押したらずっと会話する　※キャンセルボタンないが、一旦再読み込みでキャンセルとなる
- 今までの会話を保持しながら話す
- iPhoneでも音声出力できるようにする
- デモサイトの構成図
![image](https://github.com/user-attachments/assets/17ba02fb-200f-44a9-a990-9b352dcf7615)

### メモ：セキュリティ観点で本番は以下の設定が必要
| 設定項目                               | 開発中 | 本番             |
| ---------------------------------- | --------- | ------------------------------ |
| `Access-Control-Allow-Credentials` | （なし）      | `true`（必要なら）                   |
| CloudFront キャッシュキー                 | （特になし）    | `Origin` を含めて設定                |
| APIキーの保護                 | Lambda環境変数    | Secrets Manager利用（チーム開発でなければ必須ではない）      |

## マイコン化について
- ラズパイだとおもちゃの価格が跳ね上がる。価格を抑えるためにはマイコン化が必要
- マイコン化すると、ラズパイと比べスペックがかなり落ちて機能も制限される
- そのため、おもちゃはマイク/スピーカーの中継にして、BlueTooth/wifiでスマホと連携して、スマホ側で音声処理をする構成にする
- そうすると、スマホアプリ起動が前提になるので、親としては子供がおもちゃと会話している間はスマホを操作できなくなってしまう可能性がある
- アプリをバックグラウンド起動させて対応できないか検討中　※最悪、親がスマホを触る際は、会話モード以外（オウム返しや一方的な話）で楽しんでもらう
- [ToyTalkマイコン実装はこちら](docs/mcu.md)

## ラズパイ対応 ver1　※対応済み
- デモサイトでやってること（ブラウザ部分）をラズパイに置き換えるだけ
<img width="1347" height="462" alt="image" src="https://github.com/user-attachments/assets/071819ff-889c-44b8-bd77-c961d8270439" />

- マイク/スピーカーはUSBタイプのものをそれぞれ用意してラズパイに装着
- VADは簡単なものを実装。咳や物音といった短い音を無視（0.4秒以内の音声は検知しない）
- 音声を流している間は、割り込みのマイク入力はoff　※ありだとスピーカーの音をマイクが拾う、の無限ループになるため。マイコン化を考えると制御の難易度が高そう
- 今後の課題も同じく、返答速度・声がメイン
  - 速度：①base64処理とmp3/wavの処理最適化、②システムプロンプトを会話特化に、③相槌機能追加（Lambdaの2重化）で、改善&カバーを検討
  - 声：今のOpenAI APIでチューニングしつつ、別のTTS用APIを検討

## ラズパイ対応 ver2　※対応済み
- スマホアプリ（一旦iOS）を作り、アプリ側で音声処理を行う。ラズパイはマイク/スピーカーの中継だけ（マイコン化に向けた対応）
<img width="1351" height="456" alt="image" src="https://github.com/user-attachments/assets/c09baf43-5672-4c0d-b494-8947d178093b" />

- このあたりで速度改善、VAD、声のチューニングの本格対応を始める？マイコン化を優先？
- 一旦速度改善できた。Lambdaのストリーミング処理でLLM/TTSをそれぞれ並列化。STT（VADも）は一旦スマホ側で処理。今後SSTもサーバー側へ移行する
- iOSアプリ（TestFlifhtというアプリのダウンロードも必要。会話機能だけ）：
- https://testflight.apple.com/join/Aq5D8b62
- [ToyTalkアプリ実装はこちら](app/README.md)
- 調査進めたところ、アプリ経由でなくても、おもちゃ（ESP32 s3という安価なマイコン）⇔中継サーバーで直接やりとりできそう。ver2の構成はとりやめて、ver3の構成にする

## ラズパイ対応 ver3　※対応中
- iOSアプリでラズパイのwifi設定をできるようにする
- SST（音声のテキスト化）をサーバー側に移行する（あわせてVAD機能をクライアント側に実装）
<img width="1373" height="456" alt="image" src="https://github.com/user-attachments/assets/04f6af68-4a57-491b-898a-42d45e6870e2" />






